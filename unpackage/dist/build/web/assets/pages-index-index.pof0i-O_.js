import{n as t,s as e,a,b as s,h as l,c as o,w as i,i as n,o as c,d as r,e as d,t as m,f as h,g as u,r as f,F as p,j as y,k as g,I as T,l as b}from"./index-CoNwD4i1.js";import{a as _}from"./api.D7tYKUGc.js";import{_ as C}from"./_plugin-vue_export-helper.BCo6x5W8.js";const w=C({data:()=>({bills:[],cardTotal:0,cashTotal:0,cardPercent:0,cashPercent:0,payTypeIndex:0,memberIndex:0,voiceText:"",showForm:!1,form:{date:"",category:"",amount:"",payType:"",memberId:"",location:""},payTypes:["刷卡","现金","支付宝","微信"],members:[],isEdit:!1,editBillId:"",monthTotal:0,monthCardTotal:0,monthCashTotal:0,monthCardPercent:0,monthCashPercent:0}),computed:{memberNames(){return this.members.map((t=>t.name))}},onLoad(){this.loadBills(),this.loadStats(),this.loadMembers(),this.autoFixData()},methods:{goToMembers(){t({url:"/pages/members/members"})},async startVoice(){e({title:"模拟语音输入",editable:!0,placeholderText:"如：我今天刷卡买了10斤大米花了50元",success:t=>{t.confirm&&t.content&&this.onVoiceResult(t.content)}})},stopVoice(){},async onVoiceResult(t){this.voiceText=t;const e=this.parseVoiceText(t);this.form={...this.form,...e};const a=this.payTypes.indexOf(this.form.payType);if(this.payTypeIndex=a>=0?a:0,this.form.memberId){const t=this.members.findIndex((t=>t._id===this.form.memberId));this.memberIndex=t>=0?t:0}this.showForm=!0},parseVoiceText(t){const e={date:this.formatDate(new Date),category:"",amount:"",payType:"",memberId:"",location:""};/工资/.test(t)?e.category="工资":/购物|买/.test(t)?e.category="购物":/餐饮|吃/.test(t)?e.category="餐饮":/交通/.test(t)?e.category="交通":/医疗|看病/.test(t)?e.category="医疗":/菜/.test(t)&&(e.category="菜"),t.includes("刷卡")?e.payType="刷卡":t.includes("现金")?e.payType="现金":t.includes("支付宝")?e.payType="支付宝":t.includes("微信")&&(e.payType="微信");const a=t.match(/([0-9]+(\.[0-9]+)?)元|([0-9]+(\.[0-9]+)?)/);a&&(e.amount=a[1]||a[3]);for(const s of this.members)if(t.includes(s.name)){e.memberId=s._id;break}return(t.includes("超市")||t.includes("菜市场"))&&(e.location=t.includes("超市")?"超市":"菜市场"),e},onEditBill(t){this.isEdit=!0,this.editBillId=t._id,this.form={date:this.formatDate(t.date),category:t.category,amount:t.amount,payType:t.payType,memberId:t.memberId,location:t.location||""};const e=this.payTypes.indexOf(this.form.payType);this.payTypeIndex=e>=0?e:0;const a=this.members.findIndex((t=>t._id===this.form.memberId));this.memberIndex=a>=0?a:0,this.showForm=!0},async onDeleteBill(t){const a=this;e({title:"确认删除",content:"确定要删除这条账单吗？",success:async e=>{e.confirm&&(await _.deleteBill(t),a.loadBills(),a.loadStats())}})},async submitBill(){let t=[];if(this.form.date||t.push("日期"),this.form.category||t.push("类别"),this.form.amount||t.push("金额"),this.form.payType||t.push("方式"),this.form.memberId||t.push("成员"),t.length)a({title:"请填写完整："+t.join("、"),icon:"none"});else{if(this.isEdit&&this.editBillId){const t={...this.form,date:new Date(this.form.date),_id:this.editBillId};await _.updateBill(t)}else{const t={...this.form,date:new Date(this.form.date)};await _.addBill(t)}this.showForm=!1,this.isEdit=!1,this.editBillId="",this.loadBills(),this.loadStats()}},async loadBills(){const t=await _.getBills({pageSize:10,sortBy:"date",sortOrder:"desc"});200===t.code&&(this.bills=t.data.list)},async loadStats(){const t=await _.getBills({payType:"刷卡"}),e=await _.getBills({payType:"现金"});this.cardTotal=t.data&&t.data.list?t.data.list.reduce(((t,e)=>t+Number(e.amount)),0):0,this.cashTotal=e.data&&e.data.list?e.data.list.reduce(((t,e)=>t+Number(e.amount)),0):0;const a=this.cardTotal+this.cashTotal,s=a?this.cardTotal/a*100:0,l=a?this.cashTotal/a*100:0;this.cardPercent=s.toFixed(1),this.cashPercent=l.toFixed(1);const o=new Date,i=new Date(o.getFullYear(),o.getMonth(),1),n=new Date(o.getFullYear(),o.getMonth()+1,1);try{const t=await _.getBills({pageSize:1e3});if(t.data&&t.data.list){const e=t.data.list.filter((t=>{const e=new Date(t.date);return e>=i&&e<n}));this.monthTotal=e.reduce(((t,e)=>t+Number(e.amount)),0);const a=e.filter((t=>"刷卡"===t.payType)),s=e.filter((t=>"现金"===t.payType));this.monthCardTotal=a.reduce(((t,e)=>t+Number(e.amount)),0),this.monthCashTotal=s.reduce(((t,e)=>t+Number(e.amount)),0);const l=this.monthTotal?this.monthCardTotal/this.monthTotal*100:0,o=this.monthTotal?this.monthCashTotal/this.monthTotal*100:0;this.monthCardPercent=l.toFixed(1),this.monthCashPercent=o.toFixed(1)}else this.monthTotal=0,this.monthCardTotal=0,this.monthCashTotal=0,this.monthCardPercent=0,this.monthCashPercent=0}catch(c){console.error("加载统计数据失败:",c),this.monthTotal=0,this.monthCardTotal=0,this.monthCashTotal=0,this.monthCardPercent=0,this.monthCashPercent=0}},async loadMembers(){const t=await _.getMembers();200===t.code&&(this.members=t.data.list)},getMemberName(t){const e=this.members.find((e=>e._id===t));return e?e.name:""},formatDate(t){if(!t)return"";const e="string"==typeof t?new Date(t):t;if(isNaN(e.getTime()))return"";return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`},onPayTypeChange(t){this.payTypeIndex=t.detail.value,this.form.payType=this.payTypes[this.payTypeIndex]},onMemberChange(t){this.memberIndex=t.detail.value,this.form.memberId=this.members[this.memberIndex]._id},async refreshData(){s({title:"刷新中..."});try{await this.loadBills(),await this.loadStats(),await this.loadMembers(),a({title:"数据已刷新",icon:"success"})}catch(t){console.error("刷新数据失败:",t),a({title:"刷新失败",icon:"none"})}finally{l()}},async checkSystem(){s({title:"检查中..."});try{let s=[];try{200===(await _.getBills({pageSize:1})).code?s.push("✅ API 连接正常"):s.push("❌ API 连接失败")}catch(t){s.push("❌ API 连接异常")}try{const t=await _.getBills({pageSize:1e3});t.data&&t.data.list?s.push(`✅ 账单数据正常 (共${t.data.list.length}条)`):s.push("❌ 账单数据获取失败")}catch(t){s.push("❌ 账单数据获取异常")}try{const t=await _.getMembers();200===t.code&&t.data&&t.data.list?s.push(`✅ 成员数据正常 (共${t.data.list.length}人)`):s.push("❌ 成员数据获取失败")}catch(t){s.push("❌ 成员数据获取异常")}try{const t=new Date,e=new Date(t.getFullYear(),t.getMonth(),1),a=new Date(t.getFullYear(),t.getMonth()+1,1),l=await _.getBills({pageSize:1e3});if(l.data&&l.data.list){const t=l.data.list.filter((t=>{const s=new Date(t.date);return s>=e&&s<a})).reduce(((t,e)=>t+Number(e.amount)),0);s.push(`✅ 本月统计正常 (总支出¥${t.toFixed(2)})`)}else s.push("❌ 本月统计计算失败")}catch(t){s.push("❌ 本月统计计算异常")}const o=s.filter((t=>t.startsWith("✅"))).length,i=s.length;o===i?a({title:"系统运行正常",icon:"success"}):e({title:"系统检查结果",content:`检查项目: ${i}项\n正常: ${o}项\n异常: ${i-o}项\n\n${s.join("\n")}`,showCancel:!1})}catch(t){console.error("系统检查失败:",t),a({title:"系统检查失败",icon:"none"})}finally{l()}},async simpleInit(){e({title:"初始化确认",content:"确定要创建默认成员和示例数据吗？",success:async t=>{if(t.confirm){s({title:"初始化中..."});try{const t=await _.getMembers();200===t.code&&t.data&&0===t.data.list.length&&(await _.addMember({name:"张三",description:"家庭成员"}),await _.addMember({name:"李四",description:"家庭成员"}));const e=await _.getBills({pageSize:1});if(200===e.code&&e.data&&0===e.data.list.length){const t=(new Date).toISOString().split("T")[0];await _.addBill({amount:100,category:"餐饮",description:"午餐",date:t,payType:"现金",location:"食堂"})}a({title:"初始化完成",icon:"success"}),await this.loadBills(),await this.loadStats(),await this.loadMembers()}catch(e){console.error("初始化失败:",e),a({title:"初始化失败",icon:"none"})}finally{l()}}}})},async autoFixData(){0===this.monthTotal&&setTimeout((()=>{this.loadStats()}),1e3)},async checkInitStatus(){try{const t=await _.getBills({pageSize:1}),e=await _.getMembers();if(200===t.code&&200===e.code){t.data&&t.data.list&&t.data.list.length,e.data&&e.data.list&&e.data.list.length}}catch(t){console.error("检查系统状态失败:",t)}},goToTest(){t({url:"/pages/test/test"})}}},[["render",function(t,e,a,s,l,_){const C=y,w=n,x=g,I=T,k=b;return c(),o(w,null,{default:i((()=>[r(w,{class:"container"},{default:i((()=>[r(w,{style:{display:"flex","justify-content":"flex-end","margin-bottom":"10px"}},{default:i((()=>[r(C,{onClick:_.goToMembers,style:{background:"#409EFF",color:"#fff"}},{default:i((()=>[d("成员管理")])),_:1},8,["onClick"]),r(C,{onClick:_.refreshData,style:{background:"#67C23A",color:"#fff","margin-left":"10px"}},{default:i((()=>[d("刷新数据")])),_:1},8,["onClick"]),r(C,{onClick:_.checkSystem,style:{background:"#E6A23C",color:"#fff","margin-left":"10px"}},{default:i((()=>[d("系统检查")])),_:1},8,["onClick"]),r(C,{onClick:_.simpleInit,style:{background:"#909399",color:"#fff","margin-left":"10px"}},{default:i((()=>[d("初始化")])),_:1},8,["onClick"]),r(C,{onClick:_.goToTest,style:{background:"#F56C6C",color:"#fff","margin-left":"10px"}},{default:i((()=>[d("系统诊断")])),_:1},8,["onClick"])])),_:1}),r(w,{class:"stats-card"},{default:i((()=>[r(w,{class:"stats-item"},{default:i((()=>[r(x,{class:"stats-label"},{default:i((()=>[d("刷卡消费")])),_:1}),r(x,{class:"stats-value"},{default:i((()=>[d("¥"+m(l.cardTotal),1)])),_:1}),r(x,{class:"stats-percent"},{default:i((()=>[d("("+m(l.cardPercent)+"%)",1)])),_:1})])),_:1}),r(w,{class:"stats-item"},{default:i((()=>[r(x,{class:"stats-label"},{default:i((()=>[d("现金消费")])),_:1}),r(x,{class:"stats-value"},{default:i((()=>[d("¥"+m(l.cashTotal),1)])),_:1}),r(x,{class:"stats-percent"},{default:i((()=>[d("("+m(l.cashPercent)+"%)",1)])),_:1})])),_:1}),r(w,{class:"stats-item",style:{"margin-top":"10px"}},{default:i((()=>[r(x,{class:"stats-label"},{default:i((()=>[d("本月总支出")])),_:1}),r(x,{class:"stats-value"},{default:i((()=>[d("¥"+m(l.monthTotal),1)])),_:1})])),_:1}),r(w,{class:"stats-item",style:{"margin-top":"2px"}},{default:i((()=>[r(x,{class:"stats-label"},{default:i((()=>[d("本月刷卡")])),_:1}),r(x,{class:"stats-value"},{default:i((()=>[d("¥"+m(l.monthCardTotal),1)])),_:1}),r(x,{class:"stats-percent"},{default:i((()=>[d("("+m(l.monthCardPercent)+"%)",1)])),_:1})])),_:1}),r(w,{class:"stats-item",style:{"margin-top":"2px"}},{default:i((()=>[r(x,{class:"stats-label"},{default:i((()=>[d("本月现金")])),_:1}),r(x,{class:"stats-value"},{default:i((()=>[d("¥"+m(l.monthCashTotal),1)])),_:1}),r(x,{class:"stats-percent"},{default:i((()=>[d("("+m(l.monthCashPercent)+"%)",1)])),_:1})])),_:1})])),_:1}),r(w,{class:"voice-section"},{default:i((()=>[r(C,{class:"voice-btn",onClick:_.startVoice},{default:i((()=>[r(x,{class:"voice-icon"},{default:i((()=>[d("🎤")])),_:1}),r(x,null,{default:i((()=>[d("语音记账")])),_:1})])),_:1},8,["onClick"]),l.voiceText?(c(),o(w,{key:0,class:"voice-result"},{default:i((()=>[r(x,null,{default:i((()=>[d("识别结果："+m(l.voiceText),1)])),_:1})])),_:1})):h("",!0)])),_:1}),l.showForm?(c(),o(w,{key:0,class:"quick-form"},{default:i((()=>[r(w,{class:"form-item"},{default:i((()=>[r(x,null,{default:i((()=>[d("日期")])),_:1}),r(I,{modelValue:l.form.date,"onUpdate:modelValue":e[0]||(e[0]=t=>l.form.date=t),type:"date"},null,8,["modelValue"])])),_:1}),r(w,{class:"form-item"},{default:i((()=>[r(x,null,{default:i((()=>[d("品种")])),_:1}),r(I,{modelValue:l.form.category,"onUpdate:modelValue":e[1]||(e[1]=t=>l.form.category=t),placeholder:"如大米"},null,8,["modelValue"])])),_:1}),r(w,{class:"form-item"},{default:i((()=>[r(x,null,{default:i((()=>[d("金额")])),_:1}),r(I,{modelValue:l.form.amount,"onUpdate:modelValue":e[2]||(e[2]=t=>l.form.amount=t),type:"number"},null,8,["modelValue"])])),_:1}),r(w,{class:"form-item"},{default:i((()=>[r(x,null,{default:i((()=>[d("方式")])),_:1}),r(k,{range:l.payTypes,value:l.payTypeIndex,onChange:_.onPayTypeChange},{default:i((()=>[r(w,{class:"picker-value"},{default:i((()=>[d(m(l.form.payType||"请选择方式"),1)])),_:1})])),_:1},8,["range","value","onChange"])])),_:1}),r(w,{class:"form-item"},{default:i((()=>[r(x,null,{default:i((()=>[d("成员")])),_:1}),r(k,{range:_.memberNames,value:l.memberIndex,onChange:_.onMemberChange},{default:i((()=>[r(w,{class:"picker-value"},{default:i((()=>[d(m(_.getMemberName(l.form.memberId)||"请选择成员"),1)])),_:1})])),_:1},8,["range","value","onChange"])])),_:1}),r(w,{class:"form-item"},{default:i((()=>[r(x,null,{default:i((()=>[d("购买地点")])),_:1}),r(I,{modelValue:l.form.location,"onUpdate:modelValue":e[3]||(e[3]=t=>l.form.location=t),placeholder:"如超市、菜市场"},null,8,["modelValue"])])),_:1}),r(C,{onClick:_.submitBill},{default:i((()=>[d("保存账单")])),_:1},8,["onClick"])])),_:1})):h("",!0),r(w,{class:"bill-list"},{default:i((()=>[r(w,{class:"list-header"},{default:i((()=>[r(x,null,{default:i((()=>[d("最近账单")])),_:1})])),_:1}),0===l.bills.length?(c(),o(w,{key:0,class:"empty-state"},{default:i((()=>[r(x,null,{default:i((()=>[d("暂无账单记录")])),_:1})])),_:1})):(c(),o(w,{key:1},{default:i((()=>[(c(!0),u(p,null,f(l.bills,(t=>(c(),o(w,{key:t._id,class:"bill-item"},{default:i((()=>[r(x,null,{default:i((()=>[d(m(_.formatDate(t.date))+" "+m(t.category)+" ¥"+m(t.amount)+" ("+m(t.payType)+") - "+m(_.getMemberName(t.memberId)),1),t.location?(c(),u("span",{key:0}," @"+m(t.location),1)):h("",!0)])),_:2},1024),r(C,{size:"mini",onClick:e=>_.onEditBill(t)},{default:i((()=>[d("编辑")])),_:2},1032,["onClick"]),r(C,{size:"mini",type:"warn",onClick:e=>_.onDeleteBill(t._id)},{default:i((()=>[d("删除")])),_:2},1032,["onClick"])])),_:2},1024)))),128))])),_:1}))])),_:1})])),_:1})])),_:1})}]]);export{w as default};

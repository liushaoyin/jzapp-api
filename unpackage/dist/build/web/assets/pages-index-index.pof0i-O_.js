import{n as t,s as e,a,b as s,h as l,c as o,w as i,i as n,o as c,d as r,e as d,t as m,f as h,g as u,r as f,F as p,j as y,k as g,I as T,l as b}from"./index-CoNwD4i1.js";import{a as _}from"./api.D7tYKUGc.js";import{_ as C}from"./_plugin-vue_export-helper.BCo6x5W8.js";const w=C({data:()=>({bills:[],cardTotal:0,cashTotal:0,cardPercent:0,cashPercent:0,payTypeIndex:0,memberIndex:0,voiceText:"",showForm:!1,form:{date:"",category:"",amount:"",payType:"",memberId:"",location:""},payTypes:["åˆ·å¡","çŽ°é‡‘","æ”¯ä»˜å®","å¾®ä¿¡"],members:[],isEdit:!1,editBillId:"",monthTotal:0,monthCardTotal:0,monthCashTotal:0,monthCardPercent:0,monthCashPercent:0}),computed:{memberNames(){return this.members.map((t=>t.name))}},onLoad(){this.loadBills(),this.loadStats(),this.loadMembers(),this.autoFixData()},methods:{goToMembers(){t({url:"/pages/members/members"})},async startVoice(){e({title:"æ¨¡æ‹Ÿè¯­éŸ³è¾“å…¥",editable:!0,placeholderText:"å¦‚ï¼šæˆ‘ä»Šå¤©åˆ·å¡ä¹°äº†10æ–¤å¤§ç±³èŠ±äº†50å…ƒ",success:t=>{t.confirm&&t.content&&this.onVoiceResult(t.content)}})},stopVoice(){},async onVoiceResult(t){this.voiceText=t;const e=this.parseVoiceText(t);this.form={...this.form,...e};const a=this.payTypes.indexOf(this.form.payType);if(this.payTypeIndex=a>=0?a:0,this.form.memberId){const t=this.members.findIndex((t=>t._id===this.form.memberId));this.memberIndex=t>=0?t:0}this.showForm=!0},parseVoiceText(t){const e={date:this.formatDate(new Date),category:"",amount:"",payType:"",memberId:"",location:""};/å·¥èµ„/.test(t)?e.category="å·¥èµ„":/è´­ç‰©|ä¹°/.test(t)?e.category="è´­ç‰©":/é¤é¥®|åƒ/.test(t)?e.category="é¤é¥®":/äº¤é€š/.test(t)?e.category="äº¤é€š":/åŒ»ç–—|çœ‹ç—…/.test(t)?e.category="åŒ»ç–—":/èœ/.test(t)&&(e.category="èœ"),t.includes("åˆ·å¡")?e.payType="åˆ·å¡":t.includes("çŽ°é‡‘")?e.payType="çŽ°é‡‘":t.includes("æ”¯ä»˜å®")?e.payType="æ”¯ä»˜å®":t.includes("å¾®ä¿¡")&&(e.payType="å¾®ä¿¡");const a=t.match(/([0-9]+(\.[0-9]+)?)å…ƒ|([0-9]+(\.[0-9]+)?)/);a&&(e.amount=a[1]||a[3]);for(const s of this.members)if(t.includes(s.name)){e.memberId=s._id;break}return(t.includes("è¶…å¸‚")||t.includes("èœå¸‚åœº"))&&(e.location=t.includes("è¶…å¸‚")?"è¶…å¸‚":"èœå¸‚åœº"),e},onEditBill(t){this.isEdit=!0,this.editBillId=t._id,this.form={date:this.formatDate(t.date),category:t.category,amount:t.amount,payType:t.payType,memberId:t.memberId,location:t.location||""};const e=this.payTypes.indexOf(this.form.payType);this.payTypeIndex=e>=0?e:0;const a=this.members.findIndex((t=>t._id===this.form.memberId));this.memberIndex=a>=0?a:0,this.showForm=!0},async onDeleteBill(t){const a=this;e({title:"ç¡®è®¤åˆ é™¤",content:"ç¡®å®šè¦åˆ é™¤è¿™æ¡è´¦å•å—ï¼Ÿ",success:async e=>{e.confirm&&(await _.deleteBill(t),a.loadBills(),a.loadStats())}})},async submitBill(){let t=[];if(this.form.date||t.push("æ—¥æœŸ"),this.form.category||t.push("ç±»åˆ«"),this.form.amount||t.push("é‡‘é¢"),this.form.payType||t.push("æ–¹å¼"),this.form.memberId||t.push("æˆå‘˜"),t.length)a({title:"è¯·å¡«å†™å®Œæ•´ï¼š"+t.join("ã€"),icon:"none"});else{if(this.isEdit&&this.editBillId){const t={...this.form,date:new Date(this.form.date),_id:this.editBillId};await _.updateBill(t)}else{const t={...this.form,date:new Date(this.form.date)};await _.addBill(t)}this.showForm=!1,this.isEdit=!1,this.editBillId="",this.loadBills(),this.loadStats()}},async loadBills(){const t=await _.getBills({pageSize:10,sortBy:"date",sortOrder:"desc"});200===t.code&&(this.bills=t.data.list)},async loadStats(){const t=await _.getBills({payType:"åˆ·å¡"}),e=await _.getBills({payType:"çŽ°é‡‘"});this.cardTotal=t.data&&t.data.list?t.data.list.reduce(((t,e)=>t+Number(e.amount)),0):0,this.cashTotal=e.data&&e.data.list?e.data.list.reduce(((t,e)=>t+Number(e.amount)),0):0;const a=this.cardTotal+this.cashTotal,s=a?this.cardTotal/a*100:0,l=a?this.cashTotal/a*100:0;this.cardPercent=s.toFixed(1),this.cashPercent=l.toFixed(1);const o=new Date,i=new Date(o.getFullYear(),o.getMonth(),1),n=new Date(o.getFullYear(),o.getMonth()+1,1);try{const t=await _.getBills({pageSize:1e3});if(t.data&&t.data.list){const e=t.data.list.filter((t=>{const e=new Date(t.date);return e>=i&&e<n}));this.monthTotal=e.reduce(((t,e)=>t+Number(e.amount)),0);const a=e.filter((t=>"åˆ·å¡"===t.payType)),s=e.filter((t=>"çŽ°é‡‘"===t.payType));this.monthCardTotal=a.reduce(((t,e)=>t+Number(e.amount)),0),this.monthCashTotal=s.reduce(((t,e)=>t+Number(e.amount)),0);const l=this.monthTotal?this.monthCardTotal/this.monthTotal*100:0,o=this.monthTotal?this.monthCashTotal/this.monthTotal*100:0;this.monthCardPercent=l.toFixed(1),this.monthCashPercent=o.toFixed(1)}else this.monthTotal=0,this.monthCardTotal=0,this.monthCashTotal=0,this.monthCardPercent=0,this.monthCashPercent=0}catch(c){console.error("åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:",c),this.monthTotal=0,this.monthCardTotal=0,this.monthCashTotal=0,this.monthCardPercent=0,this.monthCashPercent=0}},async loadMembers(){const t=await _.getMembers();200===t.code&&(this.members=t.data.list)},getMemberName(t){const e=this.members.find((e=>e._id===t));return e?e.name:""},formatDate(t){if(!t)return"";const e="string"==typeof t?new Date(t):t;if(isNaN(e.getTime()))return"";return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`},onPayTypeChange(t){this.payTypeIndex=t.detail.value,this.form.payType=this.payTypes[this.payTypeIndex]},onMemberChange(t){this.memberIndex=t.detail.value,this.form.memberId=this.members[this.memberIndex]._id},async refreshData(){s({title:"åˆ·æ–°ä¸­..."});try{await this.loadBills(),await this.loadStats(),await this.loadMembers(),a({title:"æ•°æ®å·²åˆ·æ–°",icon:"success"})}catch(t){console.error("åˆ·æ–°æ•°æ®å¤±è´¥:",t),a({title:"åˆ·æ–°å¤±è´¥",icon:"none"})}finally{l()}},async checkSystem(){s({title:"æ£€æŸ¥ä¸­..."});try{let s=[];try{200===(await _.getBills({pageSize:1})).code?s.push("âœ… API è¿žæŽ¥æ­£å¸¸"):s.push("âŒ API è¿žæŽ¥å¤±è´¥")}catch(t){s.push("âŒ API è¿žæŽ¥å¼‚å¸¸")}try{const t=await _.getBills({pageSize:1e3});t.data&&t.data.list?s.push(`âœ… è´¦å•æ•°æ®æ­£å¸¸ (å…±${t.data.list.length}æ¡)`):s.push("âŒ è´¦å•æ•°æ®èŽ·å–å¤±è´¥")}catch(t){s.push("âŒ è´¦å•æ•°æ®èŽ·å–å¼‚å¸¸")}try{const t=await _.getMembers();200===t.code&&t.data&&t.data.list?s.push(`âœ… æˆå‘˜æ•°æ®æ­£å¸¸ (å…±${t.data.list.length}äºº)`):s.push("âŒ æˆå‘˜æ•°æ®èŽ·å–å¤±è´¥")}catch(t){s.push("âŒ æˆå‘˜æ•°æ®èŽ·å–å¼‚å¸¸")}try{const t=new Date,e=new Date(t.getFullYear(),t.getMonth(),1),a=new Date(t.getFullYear(),t.getMonth()+1,1),l=await _.getBills({pageSize:1e3});if(l.data&&l.data.list){const t=l.data.list.filter((t=>{const s=new Date(t.date);return s>=e&&s<a})).reduce(((t,e)=>t+Number(e.amount)),0);s.push(`âœ… æœ¬æœˆç»Ÿè®¡æ­£å¸¸ (æ€»æ”¯å‡ºÂ¥${t.toFixed(2)})`)}else s.push("âŒ æœ¬æœˆç»Ÿè®¡è®¡ç®—å¤±è´¥")}catch(t){s.push("âŒ æœ¬æœˆç»Ÿè®¡è®¡ç®—å¼‚å¸¸")}const o=s.filter((t=>t.startsWith("âœ…"))).length,i=s.length;o===i?a({title:"ç³»ç»Ÿè¿è¡Œæ­£å¸¸",icon:"success"}):e({title:"ç³»ç»Ÿæ£€æŸ¥ç»“æžœ",content:`æ£€æŸ¥é¡¹ç›®: ${i}é¡¹\næ­£å¸¸: ${o}é¡¹\nå¼‚å¸¸: ${i-o}é¡¹\n\n${s.join("\n")}`,showCancel:!1})}catch(t){console.error("ç³»ç»Ÿæ£€æŸ¥å¤±è´¥:",t),a({title:"ç³»ç»Ÿæ£€æŸ¥å¤±è´¥",icon:"none"})}finally{l()}},async simpleInit(){e({title:"åˆå§‹åŒ–ç¡®è®¤",content:"ç¡®å®šè¦åˆ›å»ºé»˜è®¤æˆå‘˜å’Œç¤ºä¾‹æ•°æ®å—ï¼Ÿ",success:async t=>{if(t.confirm){s({title:"åˆå§‹åŒ–ä¸­..."});try{const t=await _.getMembers();200===t.code&&t.data&&0===t.data.list.length&&(await _.addMember({name:"å¼ ä¸‰",description:"å®¶åº­æˆå‘˜"}),await _.addMember({name:"æŽå››",description:"å®¶åº­æˆå‘˜"}));const e=await _.getBills({pageSize:1});if(200===e.code&&e.data&&0===e.data.list.length){const t=(new Date).toISOString().split("T")[0];await _.addBill({amount:100,category:"é¤é¥®",description:"åˆé¤",date:t,payType:"çŽ°é‡‘",location:"é£Ÿå ‚"})}a({title:"åˆå§‹åŒ–å®Œæˆ",icon:"success"}),await this.loadBills(),await this.loadStats(),await this.loadMembers()}catch(e){console.error("åˆå§‹åŒ–å¤±è´¥:",e),a({title:"åˆå§‹åŒ–å¤±è´¥",icon:"none"})}finally{l()}}}})},async autoFixData(){0===this.monthTotal&&setTimeout((()=>{this.loadStats()}),1e3)},async checkInitStatus(){try{const t=await _.getBills({pageSize:1}),e=await _.getMembers();if(200===t.code&&200===e.code){t.data&&t.data.list&&t.data.list.length,e.data&&e.data.list&&e.data.list.length}}catch(t){console.error("æ£€æŸ¥ç³»ç»ŸçŠ¶æ€å¤±è´¥:",t)}},goToTest(){t({url:"/pages/test/test"})}}},[["render",function(t,e,a,s,l,_){const C=y,w=n,x=g,I=T,k=b;return c(),o(w,null,{default:i((()=>[r(w,{class:"container"},{default:i((()=>[r(w,{style:{display:"flex","justify-content":"flex-end","margin-bottom":"10px"}},{default:i((()=>[r(C,{onClick:_.goToMembers,style:{background:"#409EFF",color:"#fff"}},{default:i((()=>[d("æˆå‘˜ç®¡ç†")])),_:1},8,["onClick"]),r(C,{onClick:_.refreshData,style:{background:"#67C23A",color:"#fff","margin-left":"10px"}},{default:i((()=>[d("åˆ·æ–°æ•°æ®")])),_:1},8,["onClick"]),r(C,{onClick:_.checkSystem,style:{background:"#E6A23C",color:"#fff","margin-left":"10px"}},{default:i((()=>[d("ç³»ç»Ÿæ£€æŸ¥")])),_:1},8,["onClick"]),r(C,{onClick:_.simpleInit,style:{background:"#909399",color:"#fff","margin-left":"10px"}},{default:i((()=>[d("åˆå§‹åŒ–")])),_:1},8,["onClick"]),r(C,{onClick:_.goToTest,style:{background:"#F56C6C",color:"#fff","margin-left":"10px"}},{default:i((()=>[d("ç³»ç»Ÿè¯Šæ–­")])),_:1},8,["onClick"])])),_:1}),r(w,{class:"stats-card"},{default:i((()=>[r(w,{class:"stats-item"},{default:i((()=>[r(x,{class:"stats-label"},{default:i((()=>[d("åˆ·å¡æ¶ˆè´¹")])),_:1}),r(x,{class:"stats-value"},{default:i((()=>[d("Â¥"+m(l.cardTotal),1)])),_:1}),r(x,{class:"stats-percent"},{default:i((()=>[d("("+m(l.cardPercent)+"%)",1)])),_:1})])),_:1}),r(w,{class:"stats-item"},{default:i((()=>[r(x,{class:"stats-label"},{default:i((()=>[d("çŽ°é‡‘æ¶ˆè´¹")])),_:1}),r(x,{class:"stats-value"},{default:i((()=>[d("Â¥"+m(l.cashTotal),1)])),_:1}),r(x,{class:"stats-percent"},{default:i((()=>[d("("+m(l.cashPercent)+"%)",1)])),_:1})])),_:1}),r(w,{class:"stats-item",style:{"margin-top":"10px"}},{default:i((()=>[r(x,{class:"stats-label"},{default:i((()=>[d("æœ¬æœˆæ€»æ”¯å‡º")])),_:1}),r(x,{class:"stats-value"},{default:i((()=>[d("Â¥"+m(l.monthTotal),1)])),_:1})])),_:1}),r(w,{class:"stats-item",style:{"margin-top":"2px"}},{default:i((()=>[r(x,{class:"stats-label"},{default:i((()=>[d("æœ¬æœˆåˆ·å¡")])),_:1}),r(x,{class:"stats-value"},{default:i((()=>[d("Â¥"+m(l.monthCardTotal),1)])),_:1}),r(x,{class:"stats-percent"},{default:i((()=>[d("("+m(l.monthCardPercent)+"%)",1)])),_:1})])),_:1}),r(w,{class:"stats-item",style:{"margin-top":"2px"}},{default:i((()=>[r(x,{class:"stats-label"},{default:i((()=>[d("æœ¬æœˆçŽ°é‡‘")])),_:1}),r(x,{class:"stats-value"},{default:i((()=>[d("Â¥"+m(l.monthCashTotal),1)])),_:1}),r(x,{class:"stats-percent"},{default:i((()=>[d("("+m(l.monthCashPercent)+"%)",1)])),_:1})])),_:1})])),_:1}),r(w,{class:"voice-section"},{default:i((()=>[r(C,{class:"voice-btn",onClick:_.startVoice},{default:i((()=>[r(x,{class:"voice-icon"},{default:i((()=>[d("ðŸŽ¤")])),_:1}),r(x,null,{default:i((()=>[d("è¯­éŸ³è®°è´¦")])),_:1})])),_:1},8,["onClick"]),l.voiceText?(c(),o(w,{key:0,class:"voice-result"},{default:i((()=>[r(x,null,{default:i((()=>[d("è¯†åˆ«ç»“æžœï¼š"+m(l.voiceText),1)])),_:1})])),_:1})):h("",!0)])),_:1}),l.showForm?(c(),o(w,{key:0,class:"quick-form"},{default:i((()=>[r(w,{class:"form-item"},{default:i((()=>[r(x,null,{default:i((()=>[d("æ—¥æœŸ")])),_:1}),r(I,{modelValue:l.form.date,"onUpdate:modelValue":e[0]||(e[0]=t=>l.form.date=t),type:"date"},null,8,["modelValue"])])),_:1}),r(w,{class:"form-item"},{default:i((()=>[r(x,null,{default:i((()=>[d("å“ç§")])),_:1}),r(I,{modelValue:l.form.category,"onUpdate:modelValue":e[1]||(e[1]=t=>l.form.category=t),placeholder:"å¦‚å¤§ç±³"},null,8,["modelValue"])])),_:1}),r(w,{class:"form-item"},{default:i((()=>[r(x,null,{default:i((()=>[d("é‡‘é¢")])),_:1}),r(I,{modelValue:l.form.amount,"onUpdate:modelValue":e[2]||(e[2]=t=>l.form.amount=t),type:"number"},null,8,["modelValue"])])),_:1}),r(w,{class:"form-item"},{default:i((()=>[r(x,null,{default:i((()=>[d("æ–¹å¼")])),_:1}),r(k,{range:l.payTypes,value:l.payTypeIndex,onChange:_.onPayTypeChange},{default:i((()=>[r(w,{class:"picker-value"},{default:i((()=>[d(m(l.form.payType||"è¯·é€‰æ‹©æ–¹å¼"),1)])),_:1})])),_:1},8,["range","value","onChange"])])),_:1}),r(w,{class:"form-item"},{default:i((()=>[r(x,null,{default:i((()=>[d("æˆå‘˜")])),_:1}),r(k,{range:_.memberNames,value:l.memberIndex,onChange:_.onMemberChange},{default:i((()=>[r(w,{class:"picker-value"},{default:i((()=>[d(m(_.getMemberName(l.form.memberId)||"è¯·é€‰æ‹©æˆå‘˜"),1)])),_:1})])),_:1},8,["range","value","onChange"])])),_:1}),r(w,{class:"form-item"},{default:i((()=>[r(x,null,{default:i((()=>[d("è´­ä¹°åœ°ç‚¹")])),_:1}),r(I,{modelValue:l.form.location,"onUpdate:modelValue":e[3]||(e[3]=t=>l.form.location=t),placeholder:"å¦‚è¶…å¸‚ã€èœå¸‚åœº"},null,8,["modelValue"])])),_:1}),r(C,{onClick:_.submitBill},{default:i((()=>[d("ä¿å­˜è´¦å•")])),_:1},8,["onClick"])])),_:1})):h("",!0),r(w,{class:"bill-list"},{default:i((()=>[r(w,{class:"list-header"},{default:i((()=>[r(x,null,{default:i((()=>[d("æœ€è¿‘è´¦å•")])),_:1})])),_:1}),0===l.bills.length?(c(),o(w,{key:0,class:"empty-state"},{default:i((()=>[r(x,null,{default:i((()=>[d("æš‚æ— è´¦å•è®°å½•")])),_:1})])),_:1})):(c(),o(w,{key:1},{default:i((()=>[(c(!0),u(p,null,f(l.bills,(t=>(c(),o(w,{key:t._id,class:"bill-item"},{default:i((()=>[r(x,null,{default:i((()=>[d(m(_.formatDate(t.date))+" "+m(t.category)+" Â¥"+m(t.amount)+" ("+m(t.payType)+") - "+m(_.getMemberName(t.memberId)),1),t.location?(c(),u("span",{key:0}," @"+m(t.location),1)):h("",!0)])),_:2},1024),r(C,{size:"mini",onClick:e=>_.onEditBill(t)},{default:i((()=>[d("ç¼–è¾‘")])),_:2},1032,["onClick"]),r(C,{size:"mini",type:"warn",onClick:e=>_.onDeleteBill(t._id)},{default:i((()=>[d("åˆ é™¤")])),_:2},1032,["onClick"])])),_:2},1024)))),128))])),_:1}))])),_:1})])),_:1})])),_:1})}]]);export{w as default};
